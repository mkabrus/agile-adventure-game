<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agile Adventure Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .option-button {
            transition: all 0.3s ease;
        }
        .option-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .correct {
            background-color: #22c55e !important; /* green-500 */
            color: white;
            border-color: #16a34a; /* green-600 */
        }
        .incorrect {
            background-color: #ef4444 !important; /* red-500 */
            color: white;
            border-color: #dc2626; /* red-600 */
        }
        #character {
            transition: left 1s ease-in-out;
        }
        .path-step {
            transition: background-color 0.5s ease;
        }
        .path-step.active {
            background-color: #3b82f6; /* blue-500 */
        }
        .path-step.completed {
             background-color: #22c55e; /* green-500 */
        }
        .path-step.failed {
             background-color: #ef4444; /* red-500 */
        }
        #game-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
         #modal, #start-screen, #end-screen {
            backdrop-filter: blur(10px);
            background-color: rgba(255,255,255,0.7);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- FIX: Added min-h-[500px] to ensure the container has enough height on load to show the start button -->
    <div id="game-container" class="w-full max-w-4xl mx-auto p-4 sm:p-6 md:p-8 rounded-2xl shadow-2xl overflow-hidden relative min-h-[500px]">

        <!-- Start Screen -->
        <div id="start-screen" class="absolute inset-0 z-20 flex flex-col items-center justify-center text-center p-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-gray-800 mb-4">Agile Adventure</h1>
            <p class="text-lg text-gray-600 mb-8 max-w-2xl">You are an Agile Coach leading "The Pioneers" on a quest to deliver a great product. Answer the questions correctly to clear the path to success!</p>
            <button id="start-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg transition-transform transform hover:scale-105">
                Start the Adventure
            </button>
        </div>

        <!-- Main Game UI -->
        <div id="game-ui" class="hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-2">The Journey of The Pioneers</h2>
            
            <div class="mb-6">
                <div class="w-full h-4 bg-gray-300 rounded-full relative flex items-center">
                    <div id="path-container" class="w-full h-full flex justify-between items-center px-1">
                    </div>
                    <div id="character" class="absolute top-1/2 -mt-6 w-12 h-12" style="left: 0%;">
                        <svg viewBox="0 0 100 100" class="w-full h-full">
                            <g transform="translate(50 50) scale(1.2)">
                                <path d="M 0 -35 L 20 -15 L 20 15 L 10 35 L -10 35 L -20 15 L -20 -15 Z" fill="#3b82f6" stroke="#fff" stroke-width="3"/>
                                <circle cx="0" cy="-5" r="8" fill="#fff"/>
                                <path d="M -10 20 L 10 20 L 5 35 L -5 35 Z" fill="#a0aec0"/>
                            </g>
                        </svg>
                    </div>
                </div>
                 <div class="flex justify-between text-xs text-gray-500 mt-2">
                    <span>Start</span>
                    <span>Finish</span>
                </div>
            </div>

            <div id="question-container" class="bg-white/80 p-6 rounded-xl shadow-md">
                <p id="question-number" class="text-sm font-semibold text-blue-500 mb-2"></p>
                <h3 id="question-text" class="text-xl font-semibold text-gray-800 mb-6"></h3>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
            </div>
            
            <div id="score-display" class="mt-4 text-center text-lg font-semibold text-gray-700">Score: 0</div>
        </div>

        <!-- Explanation Modal -->
        <div id="modal" class="hidden absolute inset-0 z-30 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center">
                <h2 id="modal-title" class="text-3xl font-bold mb-4"></h2>
                <p id="modal-explanation" class="text-gray-600 mb-6"></p>
                
                <!-- Gemini API Feature -->
                <div id="gemini-coach-container" class="my-6">
                    <button id="gemini-coach-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full transition-transform transform hover:scale-105">
                        âœ¨ Ask the Agile Coach
                    </button>
                    <div id="gemini-loading" class="hidden flex justify-center mt-4"><div class="spinner"></div></div>
                    <div id="gemini-response-container" class="hidden mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg text-left text-sm text-gray-700"></div>
                </div>

                <button id="next-question-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full transition-transform transform hover:scale-105">
                    Continue
                </button>
            </div>
        </div>
        
        <!-- End Screen -->
        <div id="end-screen" class="hidden absolute inset-0 z-20 flex flex-col items-center justify-center text-center p-8">
            <h1 id="end-title" class="text-4xl sm:text-5xl font-bold text-gray-800 mb-4">Adventure Complete!</h1>
            <p id="end-message" class="text-lg text-gray-600 mb-4 max-w-2xl"></p>
            <p id="final-score" class="text-2xl font-bold text-blue-600 mb-8"></p>
            <button id="restart-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg transition-transform transform hover:scale-105">
                Play Again
            </button>
        </div>

    </div>

    <script>
        const questions = [
            { question: "According to the Agile Manifesto, what is the PRIMARY measure of progress?", options: ["Comprehensive documentation", "Following the plan", "Working software", "Hours logged"], answer: 2, explanation: "The Agile Manifesto states, 'Working software is the primary measure of progress.' This emphasizes delivering tangible value over just completing tasks or creating extensive documentation." },
            { question: "What is the main purpose of the Daily Scrum?", options: ["To give a status update to the Scrum Master", "To inspect progress toward the Sprint Goal and adapt", "To plan the entire Sprint", "To discuss new features"], answer: 1, explanation: "The purpose of the Daily Scrum is for the team to inspect its progress toward the Sprint Goal and create a plan for the next 24 hours. It's a planning meeting for the team, not a status report for a manager." },
            { question: "The Scrum Guide states that a 'self-managing' team internally decides...", options: ["What the Product Goal should be", "Who is on the team", "Who does what, when, and how", "Which stakeholders to listen to"], answer: 2, explanation: "A self-managing team decides 'who does what, when, and how' to accomplish their work within the boundaries of the Sprint Goal. This empowers the team to own their process." },
            { question: "Which of the following is a common MISTAKE when creating a Sprint Goal?", options: ["Making it a single, focused objective", "Connecting it to the Product Goal", "Making it a to-do list like 'Complete stories 1-8'", "Allowing for flexibility in how to achieve it"], answer: 2, explanation: "A common mistake is turning the Sprint Goal into a to-do list (e.g., 'Complete stories X, Y, and Z'). A strong Sprint Goal is a single, valuable objective that provides focus and flexibility." },
            { question: "The primary purpose of the Sprint Retrospective is to...", options: ["Blame someone for failures", "Plan ways to increase quality and effectiveness", "Demonstrate the work done", "Socialize with the team"], answer: 1, explanation: "The purpose of the Sprint Retrospective is to 'plan ways to increase quality and effectiveness.' It's a dedicated event for the team to reflect and commit to actionable improvements." },
            { question: "A powerful 'Definition of Done' creates transparency by providing everyone...", options: ["A list of tasks for each developer", "A shared understanding of what it means for work to be complete", "Approval from the manager", "The date the work was finished"], answer: 1, explanation: "The Definition of Done (DoD) is crucial for transparency. It provides a shared, clear understanding for everyone on what quality work looks like and when an Increment is truly 'Done' and potentially usable." },
            { question: "The 'Value Delivery Formula' from the document suggests value is a combination of Working Software, Learning, and what else?", options: ["Velocity", "Story Points", "Stakeholder votes", "Relationships"], answer: 3, explanation: "The formula presented is Value = Working Software + Learning + Relationships. This highlights that true value delivery depends not just on the product, but also on continuous learning and strong, collaborative relationships." },
            { question: "The #NoEstimates movement suggests that instead of estimating, teams should focus on...", options: ["Making work items smaller and more similar in size", "Getting more accurate story point estimates", "Increasing team velocity at all costs", "Long-term planning"], answer: 0, explanation: "The #NoEstimates philosophy advocates for breaking work into small, similarly-sized pieces and then measuring flow (e.g., cycle time). This shifts the focus from debating estimates to delivering value faster." },
            { question: "A highly mature 'Definition of Done' evolves to focus not just on deployed code, but on...", options: ["Code being checked in", "The number of tests passed", "Realized business value and outcomes", "Getting manager approval"], answer: 2, explanation: "While a basic DoD focuses on technical completion, a mature DoD evolves to include whether the feature is delivering its intended value to users and achieving the desired business outcomes." },
            { question: "The document suggests that before scaling Agile with a large framework, organizations should first try to...", options: ["Hire more project managers", "Implement more processes and tools", "Descale the organization by simplifying and reducing dependencies", "Create more specialized teams"], answer: 2, explanation: "The text warns against the paradox of scaling. It suggests that instead of adding complex frameworks, organizations should first try to 'descale' by minimizing dependencies and empowering smaller, autonomous teams." }
        ];

        let currentQuestionIndex = 0;
        let score = 0;

        // UI Elements
        const startScreen = document.getElementById('start-screen');
        const endScreen = document.getElementById('end-screen');
        const gameUI = document.getElementById('game-ui');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const questionNumberEl = document.getElementById('question-number');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalExplanation = document.getElementById('modal-explanation');
        const nextQuestionButton = document.getElementById('next-question-button');
        const character = document.getElementById('character');
        const pathContainer = document.getElementById('path-container');
        const scoreDisplay = document.getElementById('score-display');

        // Gemini Feature Elements
        const geminiCoachButton = document.getElementById('gemini-coach-button');
        const geminiLoading = document.getElementById('gemini-loading');
        const geminiResponseContainer = document.getElementById('gemini-response-container');
        
        function initializeGame() {
            currentQuestionIndex = 0;
            score = 0;
            startScreen.style.display = 'flex';
            gameUI.style.display = 'none';
            endScreen.style.display = 'none';
            modal.style.display = 'none';
            updateScoreDisplay();
            createPath();
            updateCharacterPosition();
            resetGeminiCoach();
        }

        function startGame() {
            startScreen.style.display = 'none';
            gameUI.style.display = 'block';
            displayQuestion();
        }
        
        function createPath() {
            pathContainer.innerHTML = '';
            for (let i = 0; i < questions.length; i++) {
                const step = document.createElement('div');
                step.classList.add('path-step', 'w-3', 'h-3', 'bg-gray-400', 'rounded-full');
                step.id = `step-${i}`;
                pathContainer.appendChild(step);
            }
        }

        function displayQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showEndScreen();
                return;
            }
            resetGeminiCoach();
            const currentQuestion = questions[currentQuestionIndex];
            questionNumberEl.textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
            questionTextEl.textContent = currentQuestion.question;
            optionsContainer.innerHTML = '';
            currentQuestion.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button', 'w-full', 'p-4', 'text-left', 'bg-white', 'rounded-lg', 'border-2', 'border-gray-300', 'hover:border-blue-500', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-400');
                button.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(button);
            });
            const currentStep = document.getElementById(`step-${currentQuestionIndex}`);
            if(currentStep) currentStep.classList.add('active');
        }

        function selectAnswer(selectedIndex) {
            const currentQuestion = questions[currentQuestionIndex];
            const isCorrect = selectedIndex === currentQuestion.answer;
            const buttons = optionsContainer.querySelectorAll('button');
            buttons.forEach(button => button.disabled = true);
            
            buttons.forEach((button, index) => {
                if(index === currentQuestion.answer) button.classList.add('correct');
                else if (index === selectedIndex) button.classList.add('incorrect');
            });
            
            const currentStep = document.getElementById(`step-${currentQuestionIndex}`);
            if(currentStep) currentStep.classList.remove('active');

            if (isCorrect) {
                score++;
                updateScoreDisplay();
                if(currentStep) currentStep.classList.add('completed');
                setTimeout(() => {
                    currentQuestionIndex++;
                    updateCharacterPosition();
                    displayQuestion();
                }, 1000);
            } else {
                if(currentStep) currentStep.classList.add('failed');
                modalTitle.textContent = "Not Quite...";
                modalTitle.style.color = '#ef4444';
                modalExplanation.textContent = currentQuestion.explanation;
                geminiCoachButton.style.display = 'block';
                setTimeout(() => modal.style.display = 'flex', 1000);
            }
        }
        
        async function getGeminiCoaching() {
            geminiCoachButton.style.display = 'none';
            geminiLoading.style.display = 'flex';
            
            const currentQuestion = questions[currentQuestionIndex];
            const prompt = `As an expert Agile Coach, explain the concept behind this question in a helpful, encouraging tone. Provide a short, real-world scenario to illustrate the point.
            
            Question: "${currentQuestion.question}"
            
            The user answered incorrectly. The correct principle is: "${currentQuestion.explanation}"
            
            Your coaching should reinforce this principle.`;

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // API key is handled by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const result = await response.json();
                
                let text = "Sorry, I couldn't think of a good example right now. Please try again!";
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    text = result.candidates[0].content.parts[0].text;
                }
                geminiResponseContainer.innerHTML = text.replace(/\n/g, '<br>'); // Format for HTML
                
            } catch (error) {
                console.error("Gemini API call failed:", error);
                geminiResponseContainer.textContent = "There was an error getting advice from the coach. Please check the console for details.";
            } finally {
                geminiLoading.style.display = 'none';
                geminiResponseContainer.style.display = 'block';
            }
        }

        function resetGeminiCoach() {
            geminiCoachButton.style.display = 'none';
            geminiLoading.style.display = 'none';
            geminiResponseContainer.style.display = 'none';
            geminiResponseContainer.innerHTML = '';
        }

        function updateScoreDisplay() {
            scoreDisplay.textContent = `Score: ${score}`;
        }

        function updateCharacterPosition() {
             const progressPercentage = (currentQuestionIndex / questions.length) * 100;
             const adjustedPercentage = Math.min(progressPercentage, 95);
             character.style.left = `${adjustedPercentage}%`;
        }
        
        function handleNextQuestion() {
            modal.style.display = 'none';
            currentQuestionIndex++;
            updateCharacterPosition();
            displayQuestion();
        }

        function showEndScreen() {
            gameUI.style.display = 'none';
            const finalScoreEl = document.getElementById('final-score');
            const endMessageEl = document.getElementById('end-message');
            finalScoreEl.textContent = `Your Final Score: ${score} out of ${questions.length}`;
            let message = "";
            if (score === questions.length) message = "Perfect score! You're a true Agile visionary. The Pioneers have shipped an amazing product thanks to you!";
            else if (score >= 7) message = "Excellent work! You've successfully guided The Pioneers through the challenges. Your Agile knowledge is strong!";
            else if (score >= 4) message = "Good effort! You've learned a lot on this adventure. Keep refining your Agile skills!";
            else message = "The adventure was tough, but every challenge is a learning opportunity. Try again to lead The Pioneers to success!";
            endMessageEl.textContent = message;
            endScreen.style.display = 'flex';
        }

        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', initializeGame);
        nextQuestionButton.addEventListener('click', handleNextQuestion);
        geminiCoachButton.addEventListener('click', getGeminiCoaching);
        
        window.onload = initializeGame;
    </script>
</body>
</html>
